networks:
    n8n-network:
        name: n8n-network
        driver: bridge
        driver_opts:
            com.docker.network.driver.mtu: 1500  # Match QUIC MTU


services:
    postgres:
        image: postgres:14
        restart: unless-stopped
        env_file: .env
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes: [C:/Users/Jnebr/n8n_postgres:/var/lib/postgresql/data]
        networks: 
            - n8n-network
        healthcheck:  # Add health check
            test: [CMD-SHELL, pg_isready -U n8n -d n8n]
            interval: 5s
            timeout: 5s
            retries: 5
        
        
    n8n:
        image: n8nio/n8n:latest
        restart: unless-stopped
        ports: [5678:5678]
        env_file: .env
        environment:
            - DB_TYPE=${DB_TYPE}
            - DB_POSTGRESDB_HOST=${DB_POSTGRESDB_HOST}
            - DB_POSTGRESDB_PORT=${DB_POSTGRESDB_PORT}
            - DB_POSTGRESDB_DATABASE=${DB_POSTGRESDB_DATABASE}
            - DB_POSTGRESDB_USER=${DB_POSTGRESDB_USER}
            - DB_POSTGRESDB_PASSWORD=${DB_POSTGRESDB_PASSWORD}
            - N8N_RUNNERS_ENABLED=true
            - N8N_PROXY=true
            - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
            - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
            - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
            - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
            - WEBHOOK_URL=${WEBHOOK_URL}
            - N8N_RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=${N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS}
            - N8N_CORS_ALLOWED_ORIGINS=*
            - N8N_DIAGNOSTICS_ENABLED=true  # For connection debugging
            - N8N_PROTOCOL=https
            - N8N_HOST=n8n.virtualxperiencellc.com
            - N8N_EDITOR_BASE_URL=https://n8n.virtualxperiencellc.com
            - N8N_TUNNEL_HEALTH_CHECK_INTERVAL=5000
            - N8N_CORS_ALLOWED_ORIGINS=*  # Allow all origins temporarily for testing
            - N8N_PAYLOAD_SIZE_MAX=16  # Increase max payload size (in MB)
            - N8N_WEBSOCKET_TIMEOUT=60000  # 60 seconds
            - N8N_WEBSOCKET_KEEPALIVE=30000  # 30 seconds
            
            
        volumes: [C:/Users/Jnebr/n8n_data:/home/node/.n8n]
        depends_on:
            postgres:
                condition: service_healthy  # Wait for PostgreSQL to be ready
        networks: 
            - n8n-network
        healthcheck:
            test: ["CMD", "sh", "-c", "wget -q -O- http://127.0.0.1:5678/healthz || exit 1"]
            start_period: 30s
            interval: 30s
            timeout: 10s
            retries: 3
            
    cloudflared:
        restart: unless-stopped
        image: cloudflare/cloudflared:latest
        command: tunnel --config /etc/.cloudflared/config.yml run 10451b71-bfe3-4176-a5f7-27c8b5e5b61b
        sysctls:
            - net.core.rmem_max=8388608
            - net.core.wmem_max=8388608
        environment:
            - TUNNEL_ORIGIN_CERT=/etc/.cloudflared/cert.pem
        volumes: [C:/Users/Jnebr/.cloudflared:/etc/.cloudflared]
        networks: 
            - n8n-network
        depends_on: [n8n]
        healthcheck:
            test:
              - CMD
              - cloudflared
              - tunnel
              - info
              - 10451b71-bfe3-4176-a5f7-27c8b5e5b61b
            interval: 30s
            timeout: 10s
            retries: 3
